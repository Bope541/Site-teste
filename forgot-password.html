<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invict - Esqueceu a Senha</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="auth-page">

    <header class="new-navbar compact">
        <div class="container">
            <div class="logo"><a href="/"><img src="logo.png" alt="Logo da Loja" class="logo-img"></a></div>
            <div class="new-nav-actions" id="nav-auth-container">
                </div>
        </div>
    </header>

    <main class="auth-main">
        <div class="auth-card">
            
            <p id="auth-error-msg" class="auth-error" style="display:none;"></p>
            
            <div class="step-container" id="step-container">

                <div class="reset-step active" id="step-1">
                    <h2 data-key="forgot_step1_title">Redefinir sua senha</h2>
                    <p class="auth-subtitle" data-key="forgot_step1_subtitle">Digite seu e-mail e enviaremos um código de 6 dígitos.</p>
                    <form id="form-step-1" class="auth-form">
                        <div class="form-group">
                            <label for="email" data-key="forgot_email_label">E-MAIL DA CONTA</label>
                            <input type="email" id="email" name="email" placeholder="example@gmail.com" required>
                        </div>
                        <button type="submit" id="btn-step-1" class="btn btn-primary full-width" data-key="forgot_btn_send_code">Enviar Código</button>
                    </form>
                </div>

                <div class="reset-step" id="step-2">
                    <h2 data-key="forgot_step2_title">Verifique seu E-mail</h2>
                    <p class="auth-subtitle" id="subtitle-step-2" data-key="forgot_step2_subtitle">Enviamos um código de 6 dígitos para <strong>{email}</strong>.</p>
                    <form id="form-step-2" class="auth-form">
                        <div class="form-group">
                            <label for="code" data-key="forgot_code_label">CÓDIGO DE 6 DÍGITOS</label>
                            <input type="text" id="code" name="code" placeholder="123456" required>
                        </div>
                        <button type="submit" id="btn-step-2" class="btn btn-primary full-width" data-key="forgot_btn_verify">Verificar Código</button>
                    </form>
                </div>

                <div class="reset-step" id="step-3">
                    <h2 data-key="forgot_step3_title">Crie uma Nova Senha</h2>
                    <p class="auth-subtitle" id="subtitle-step-3" data-key="forgot_step3_subtitle">Olá, <strong>{username}</strong>! Digite sua nova senha.</p>
                    <form id="form-step-3" class="auth-form">
                        <div class="form-group">
                            <label for="password" data-key="forgot_new_pass_label">NOVA SENHA</label>
                            <input type="password" id="password" name="password" placeholder="********" required>
                            <i class="fas fa-eye password-toggle-icon"></i>
                        </div>
                        
                        <div class="password-requirements" id="password-req-reset">
                            <p data-key="register_req_title">Sua senha deve conter:</p>
                            <ul>
                                <li id="req-reset-length" class="invalid"><i class="fas fa-times-circle"></i> <span data-key="register_req_length">Pelo menos 8 caracteres</span></li>
                                <li id="req-reset-upper" class="invalid"><i class="fas fa-times-circle"></i> <span data-key="register_req_upper">Pelo menos 1 letra maiúscula (A–Z)</span></li>
                                <li id="req-reset-lower" class="invalid"><i class="fas fa-times-circle"></i> <span data-key="register_req_lower">Pelo menos 1 letra minúscula (a–z)</span></li>
                                <li id="req-reset-number" class="invalid"><i class="fas fa-times-circle"></i> <span data-key="register_req_number">Pelo menos 1 número (0–9)</span></li>
                                <li id="req-reset-symbol" class="invalid"><i class="fas fa-times-circle"></i> <span data-key="register_req_symbol">Pelo menos 1 símbolo especial (ex: @, #, $, !)</span></li>
                            </ul>
                        </div>

                        <div class="form-group">
                            <label for="password_confirm" data-key="forgot_confirm_pass_label">CONFIRME A NOVA SENHA</label>
                            <input type="password" id="password_confirm" name="password_confirm" placeholder="********" required>
                            <i class="fas fa-eye password-toggle-icon"></i>
                        </div>
                        <button type="submit" id="btn-step-3" class="btn btn-primary full-width" data-key="forgot_btn_save">Salvar Nova Senha</button>
                    </form>
                </div>

            </div> 
            <a href="/login" class="auth-back-link" data-key="forgot_back_to_login">Voltar para o Login</a>
        </div>
    </main>

    <footer>
        <div class="container">
            <p data-key="footer_copy">&copy; 2025 Invict. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="translations.js"></script>
    <script src="script.js"></script> 
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const stepContainer = document.getElementById('step-container');
            const steps = {
                1: document.getElementById('step-1'),
                2: document.getElementById('step-2'),
                3: document.getElementById('step-3')
            };
            const forms = {
                1: document.getElementById('form-step-1'),
                2: document.getElementById('form-step-2'),
                3: document.getElementById('form-step-3')
            };
            const buttons = {
                1: document.getElementById('btn-step-1'),
                2: document.getElementById('btn-step-2'),
                3: document.getElementById('btn-step-3')
            };
            const errorElement = document.getElementById('auth-error-msg');

            // Variáveis para guardar os dados entre as etapas
            let userEmail = '';
            let userCode = '';

            // --- Elementos de Validação de Senha ---
            const passwordInput = document.getElementById('password'); // O campo da nova senha
            const requirements = {
                length: document.getElementById('req-reset-length'),
                upper: document.getElementById('req-reset-upper'),
                lower: document.getElementById('req-reset-lower'),
                number: document.getElementById('req-reset-number'),
                symbol: document.getElementById('req-reset-symbol')
            };
            
            const validators = {
                length: val => val.length >= 8,
                upper: val => /[A-Z]/.test(val),
                lower: val => /[a-z]/.test(val),
                number: val => /[0-9]/.test(val),
                symbol: val => /[^A-Za-z0-9]/.test(val)
            };

            function updateRequirement(li, isValid) {
                if (!li) return; // Segurança
                const icon = li.querySelector('i');
                if (isValid) {
                    li.classList.remove('invalid');
                    li.classList.add('valid');
                    icon.classList.remove('fa-times-circle');
                    icon.classList.add('fa-check-circle');
                } else {
                    li.classList.remove('valid');
                    li.classList.add('invalid');
                    icon.classList.remove('fa-check-circle');
                    icon.classList.add('fa-times-circle');
                }
            }

            let isPasswordStrong = false; // Flag de controle

            function validatePassword() {
                const password = passwordInput.value;
                let allValid = true;
                
                for (const [key, validator] of Object.entries(validators)) {
                    const isValid = validator(password);
                    updateRequirement(requirements[key], isValid);
                    if (!isValid) allValid = false;
                }
                isPasswordStrong = allValid; // Atualiza a flag
                return allValid;
            }

            if (passwordInput) {
                passwordInput.addEventListener('input', validatePassword);
            }
            // --- Fim da Lógica de Validação ---


            // Função para mostrar erros
            function showError(message) {
                const lang = localStorage.getItem('language') || 'pt';
                errorElement.textContent = translations[lang][message] || message;
                errorElement.style.display = 'block';
            }

            // Função para controlar a animação
            function showStep(stepNum) {
                Object.values(steps).forEach((step, index) => {
                    if (index + 1 === stepNum) {
                        step.classList.remove('exiting');
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                        if (index + 1 < stepNum) {
                            step.classList.add('exiting');
                        }
                    }
                });

                // Ajusta a altura do container
                setTimeout(() => {
                    const activeStepHeight = steps[stepNum].offsetHeight;
                    stepContainer.style.height = `${activeStepHeight}px`;
                }, 50); // Delay para pegar a altura correta
            }

            // Função para (des)ativar o loading do botão
            function setButtonLoading(btn, isLoading) {
                if (isLoading) {
                    btn.classList.add('btn-loading');
                    btn.disabled = true;
                } else {
                    btn.classList.remove('btn-loading');
                    btn.disabled = false;
                }
            }

            // --- Lógica da Etapa 1: Enviar E-mail ---
            forms[1].addEventListener('submit', async (e) => {
                e.preventDefault();
                errorElement.style.display = 'none';
                setButtonLoading(buttons[1], true);

                userEmail = document.getElementById('email').value;

                try {
                    const response = await fetch('/api/request-reset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: userEmail })
                    });
                    
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'Erro do servidor');
                    }
                    
                    // Sucesso!
                    const lang = localStorage.getItem('language') || 'pt';
                    const subtitle = translations[lang]['forgot_step2_subtitle'].replace('{email}', userEmail);
                    document.getElementById('subtitle-step-2').innerHTML = subtitle;
                    
                    showStep(2);

                } catch (err) {
                    showError(err.message);
                } finally {
                    setButtonLoading(buttons[1], false);
                }
            });

            // --- Lógica da Etapa 2: Verificar Código ---
            forms[2].addEventListener('submit', async (e) => {
                e.preventDefault();
                errorElement.style.display = 'none';
                setButtonLoading(buttons[2], true);
                
                userCode = document.getElementById('code').value;

                try {
                    const response = await fetch('/api/verify-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: userEmail, code: userCode })
                    });
                    
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'Código incorreto');
                    }
                    
                    // Sucesso!
                    const lang = localStorage.getItem('language') || 'pt';
                    const subtitle = translations[lang]['forgot_step3_subtitle'].replace('{username}', data.username);
                    document.getElementById('subtitle-step-3').innerHTML = subtitle;
                    
                    showStep(3);

                } catch (err) {
                    showError(err.message);
                } finally {
                    setButtonLoading(buttons[2], false);
                }
            });
            
            // --- Lógica da Etapa 3: Salvar Nova Senha ---
            forms[3].addEventListener('submit', async (e) => {
                e.preventDefault();
                errorElement.style.display = 'none';
                
                const newPassword = document.getElementById('password').value;
                const confirmPassword = document.getElementById('password_confirm').value;

                // Checagem de força da senha
                if (!isPasswordStrong) {
                    showError("Sua senha não atende a todos os requisitos.");
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showError("As senhas não coincidem.");
                    return;
                }
                
                setButtonLoading(buttons[3], true);

                try {
                    const response = await fetch('/api/set-new-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email: userEmail, 
                            code: userCode, 
                            newPassword: newPassword 
                        })
                    });
                    
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'Erro ao salvar senha');
                    }
                    
                    // SUCESSO FINAL! Redireciona para o login
                    // Usamos a chave de tradução para a mensagem de sucesso
                    window.location.href = '/login?success=login_success_pass_reset';

                } catch (err) {
                    showError(err.message);
                    // Se a sessão expirar, força o usuário a recomeçar
                    if (err.message.includes('Sessão')) {
                        setTimeout(() => showStep(1), 3000);
                    }
                } finally {
                    setButtonLoading(buttons[3], false);
                }
            });

            // Ajusta a altura inicial
            showStep(1); 
        });
    </script>
</body>
</html>